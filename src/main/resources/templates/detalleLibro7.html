<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <title th:text="${libro.librotitulo}">Detalle del Libro</title>
</head>
<body class="font-sans flex flex-col min-h-screen">
<header th:replace="~{fragments/header :: header}"></header>

<section class="p-8 max-w-4xl mx-auto">
    <div class="flex gap-8">
        <img th:src="@{'/imagenes/libros/' + ${libro.libroimagen} + '.jpg'}"
             th:alt="${libro.librotitulo}" class="w-60 h-auto border shadow-lg"/>

        <div>
            <h1 class="text-3xl font-bold mb-4" th:text="${libro.librotitulo}"></h1>
            <p class="text-lg mb-2"><strong>Autor:</strong> <span th:text="${libro.libroautor}"></span></p>
            <p class="text-lg mb-2"><strong>Categoría:</strong> <span th:text="${libro.categoria.catNombre}"></span></p>
            <p class="text-base mt-4 text-justify" th:text="${libro.libroDescripcion}"></p>
        </div>
    </div>
</section>
<section class="mt-10">
    <h2 class="text-2xl font-semibold mb-4">Comentarios</h2>
    <div th:if="${#lists.isEmpty(comentarios)}">
        <p class="text-gray-500">No hay comentarios para este libro.</p>
    </div>
    <div th:each="comentario : ${comentarios}" class="border-t py-4">
        <p class="text-sm text-gray-600">
            <strong th:text="${comentario.usuario.usuNombre}">Nombre del usuario</strong>
            &bullet;
            <span th:text="${#temporals.format(comentario.comentFecha, 'dd/MM/yyyy HH:mm')}"></span>
        </p>

        <p class="mt-2" th:if="${usuarioCod == null or comentario.usuario.usuarioCod != usuarioCod}"
           th:text="${comentario.comentLibro}"></p>

        <!-- Formulario de edición solo visible para el dueño del comentario -->
        <div th:if="${comentario.usuario.usuarioCod == usuarioCod}">
            <!-- Texto normal oculto si se está editando -->
            <p class="mt-2" th:unless="${comentarioEditandoId == comentario.comentarioCod}"
               th:text="${comentario.comentLibro}"></p>

            <!-- Botón para mostrar formulario de edición -->
            <button class="text-blue-600 text-sm underline"
                    th:if="${comentarioEditandoId != comentario.comentarioCod}"
                    th:onclick="'mostrarFormularioEdicion(\'form-' + ${comentario.comentarioCod} + '\')'">Editar</button>

            <!-- Formulario de edición -->
            <form th:id="'form-' + ${comentario.comentarioCod}"
                  class="editarComentarioForm hidden mt-3"
                  th:action="@{/editarComentario}"
                  method="post">
            <input type="hidden" name="comentarioCod" th:value="${comentario.comentarioCod}" />
                <textarea name="nuevoComentario" class="w-full border p-2 rounded"
                          th:text="${comentario.comentLibro}"></textarea>
                <div class="flex gap-2 mt-2">
                    <button type="submit" class="bg-green-500 text-white px-4 py-1 rounded">Guardar</button>
                    <button type="button" onclick="ocultarFormulariosEdicion()" class="bg-gray-300 px-4 py-1 rounded">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

</section>

<footer th:replace="~{fragments/footer :: footer}"></footer>
</body>
</html>
<script>
    function mostrarFormularioEdicion(idFormulario) {
        ocultarFormulariosEdicion();
        document.getElementById(idFormulario).classList.remove('hidden');
    }

    function ocultarFormulariosEdicion() {
        document.querySelectorAll('.editarComentarioForm').forEach(f => f.classList.add('hidden'));
    }

    function mostrarFormularioEdicion(idFormulario) {
    console.log("Mostrando formulario: " + idFormulario);
    ocultarFormulariosEdicion();
    document.getElementById(idFormulario).classList.remove('hidden');
}

</script>
